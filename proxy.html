<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Browser of Doom</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dreamland"></script>

  <!-- proxy engines -->
  <script src="/baremux/index.js"></script>
  <script src="/scram/scramjet.all.js"></script>
  <script src="/proxy.config.js"></script>

  <style>
    :root {
      --bg: #0b0e14;
      --text-color: #e6e6eb;
      --secondary-text-color: #9aa0aa;
      --button-bg: #161a22;
      --button-hover: #1f2430;
      --third-bg: #2a3040;
      --primary: #7aa2ff;
    }

    html, body, #app {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      background: var(--bg);
      color: var(--text-color);
      font-family: system-ui, sans-serif;
      overflow: hidden;
    }

    .flex { display: flex; }
    .browser-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 0.5rem;
      box-sizing: border-box;
    }

    .tabs {
      display: flex;
      gap: 0.4rem;
      overflow-x: auto;
    }

    .tab, .new-tab {
      background: var(--button-bg);
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      user-select: none;
      min-width: 220px;
    }

    .tab.active { background: var(--button-hover); }
    .tab:hover { background: var(--third-bg); }

    .tab-favicon {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .tab-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tab-close {
      background: none;
      border: none;
      color: var(--secondary-text-color);
      cursor: pointer;
      font-size: 1.2rem;
    }

    .nav {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .nav button {
      background: var(--button-bg);
      border: none;
      color: var(--text-color);
      padding: 0.5rem 0.8rem;
      border-radius: 8px;
      cursor: pointer;
    }

    .nav button:hover { background: var(--button-hover); }

    input.bar {
      flex: 1;
      background: var(--button-bg);
      border: none;
      border-radius: 8px;
      padding: 0.5rem 0.8rem;
      color: var(--text-color);
      outline: none;
    }

    .iframe-container {
      flex: 1;
      margin-top: 0.5rem;
      position: relative;
    }

    iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
      background: #fff;
    }

    iframe.hidden { display: none; }
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
    /* ===== HARD FAIL GUARDS ===== */
    if (!window.$scramjetLoadController) {
      document.body.innerText = "Scramjet failed to load";
      throw new Error("Scramjet missing");
    }
    if (!window.BareMux) {
      document.body.innerText = "BareMux failed to load";
      throw new Error("BareMux missing");
    }

    /* ===== SCRAMJET ===== */
    const { ScramjetController } = $scramjetLoadController();

    const scramjet = new ScramjetController({
      files: {
        wasm: "/scram/scramjet.wasm.wasm",
        all: "/scram/scramjet.all.js",
        sync: "/scram/scramjet.sync.js"
      }
    });

    scramjet.init();

    /* ===== SERVICE WORKER ===== */
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/swsjs.js").catch(console.error);
    }

    /* ===== BAREMUX ===== */
    const connection = new BareMux.BareMuxConnection("/baremux/worker.js");

    const store = {
      wispurl: localStorage.getItem("proxServer") || "wss://gointospace.app/wisp/",
      bareurl:
        (location.protocol === "https:" ? "https" : "http") +
        "://" +
        location.host +
        "/bare/"
    };

    connection.setTransport("/epoxy/index.mjs", [{ wisp: store.wispurl }]);

    /* ===== TAB SYSTEM ===== */
    let tabs = [];
    let activeTabId = 0;
    let nextTabId = 1;

    function favicon(url) {
      try {
        return `https://t0.gstatic.com/faviconV2?url=${new URL(url).origin}&size=32`;
      } catch {
        return "";
      }
    }

    function createTab(url = "https://start.duckduckgo.com/") {
      const frame = scramjet.createFrame();
      frame.frame.src = "/page/newtab.html";

      const tab = {
        id: nextTabId++,
        url,
        title: "New Tab",
        frame,
        icon: favicon(url)
      };

      frame.addEventListener("urlchange", e => {
        if (!e.url) return;
        tab.url = e.url;
        tab.icon = favicon(e.url);
        try {
          tab.title = frame.frame.contentWindow.document.title || new URL(e.url).hostname;
        } catch {
          tab.title = new URL(e.url).hostname;
        }
        renderTabs();
        updateBar();
      });

      tabs.push(tab);
      document.getElementById("iframe-container").appendChild(frame.frame);
      switchTab(tab.id);
    }

    function switchTab(id) {
      tabs.forEach(t => t.frame.frame.classList.add("hidden"));
      activeTabId = id;
      const tab = tabs.find(t => t.id === id);
      if (tab) tab.frame.frame.classList.remove("hidden");
      renderTabs();
      updateBar();
    }

    function closeTab(id) {
      const i = tabs.findIndex(t => t.id === id);
      if (i === -1) return;
      tabs[i].frame.frame.remove();
      tabs.splice(i, 1);
      if (!tabs.length) createTab();
      else switchTab(tabs[Math.max(0, i - 1)].id);
    }

    function activeTab() {
      return tabs.find(t => t.id === activeTabId);
    }

    function updateBar() {
      const t = activeTab();
      if (t) document.getElementById("address-bar").value = t.url;
    }

    function submit() {
      const t = activeTab();
      let v = address.value.trim();
      if (!v.startsWith("http")) {
        v = v.includes(".") ? "https://" + v : "https://duckduckgo.com/?q=" + encodeURIComponent(v);
      }
      t.frame.go(v);
    }

    function renderTabs() {
      const el = document.getElementById("tabs");
      el.innerHTML = "";
      tabs.forEach(t => {
        const d = document.createElement("div");
        d.className = "tab" + (t.id === activeTabId ? " active" : "");
        d.onclick = () => switchTab(t.id);
        d.innerHTML = `
          <img class="tab-favicon" src="${t.icon}">
          <span class="tab-title">${t.title}</span>
          <button class="tab-close">×</button>
        `;
        d.querySelector(".tab-close").onclick = e => {
          e.stopPropagation();
          closeTab(t.id);
        };
        el.appendChild(d);
      });

      const add = document.createElement("div");
      add.className = "new-tab";
      add.textContent = "+";
      add.onclick = () => createTab();
      el.appendChild(add);
    }

    /* ===== UI BOOT ===== */
    app.innerHTML = `
      <div class="browser-container">
        <div class="tabs" id="tabs"></div>
        <div class="nav">
          <button onclick="activeTab()?.frame.back()">←</button>
          <button onclick="activeTab()?.frame.forward()">→</button>
          <button onclick="activeTab()?.frame.reload()">⟳</button>
          <input id="address-bar" class="bar" onkeydown="event.key==='Enter'&&submit()">
          <button onclick="window.open(scramjet.encodeUrl(activeTab()?.url))">↗</button>
        </div>
        <div class="iframe-container" id="iframe-container"></div>
      </div>
    `;

    createTab();
  </script>
</body>
</html>
